{
  "version": "2.0.0",
  "tasks": [
    // === Build Tasks ===
    {
      "label": "Build Rust Core",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && npm install && npx napi build --release --platform"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"],
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      }
    },
    {
      "label": "Build Rust Core (Debug)",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && npm install && npx napi build --platform"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Build All Platforms",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && npm install && npx napi build --release --platform --target x86_64-unknown-linux-gnu && npx napi build --release --platform --target x86_64-pc-windows-msvc && npx napi build --release --platform --target x86_64-apple-darwin && npx napi build --release --platform --target aarch64-apple-darwin"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"],
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      }
    },
    {
      "label": "Build Linux Binary",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && npx napi build --release --platform --target x86_64-unknown-linux-gnu"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Build Windows Binary",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && npx napi build --release --platform --target x86_64-pc-windows-msvc"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Build macOS Intel Binary",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && npx napi build --release --platform --target x86_64-apple-darwin"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Build macOS ARM Binary",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && export MACOSX_DEPLOYMENT_TARGET=11.0 && npx napi build --release --platform --target aarch64-apple-darwin"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Build Node Wrapper",
      "type": "shell",
      "command": "cd node-wrapper && pnpm build",
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$tsc"]
    },
    {
      "label": "Build All",
      "dependsOrder": "sequence",
      "dependsOn": ["Build Rust Core", "Build Node Wrapper"],
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "isBackground": false
    },

    // === Test Tasks ===
    {
      "label": "Test Rust Core",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && cargo test --verbose"
      ],
      "group": "test",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Test Node Unit",
      "type": "shell",
      "command": "cd node-wrapper && pnpm test:unit",
      "group": "test",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Test Node Integration",
      "type": "shell",
      "command": "cd node-wrapper && pnpm test:integration",
      "group": "test",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Test Node CLI",
      "type": "shell",
      "command": "cd node-wrapper && pnpm test:cli",
      "group": "test",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Test Node All",
      "type": "shell",
      "command": "cd node-wrapper && pnpm test",
      "group": "test",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Test All",
      "dependsOrder": "sequence",
      "dependsOn": ["Test Rust Core", "Test Node All"],
      "group": {
        "kind": "test",
        "isDefault": true
      },
      "isBackground": false
    },

    // === Lint Tasks ===
    {
      "label": "Lint Rust",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && cargo clippy --all-targets --all-features -- -D warnings"
      ],
      "group": "test",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Format Rust",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && cargo fmt"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Format Check Rust",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && cargo fmt --check"
      ],
      "group": "test",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Lint Node",
      "type": "shell",
      "command": "cd node-wrapper && pnpm lint",
      "group": "test",
      "isBackground": false,
      "problemMatcher": []
    },

    // === Validation Tasks ===
    {
      "label": "Quick Check",
      "type": "shell",
      "command": "./scripts/quick-check.sh",
      "group": "test",
      "isBackground": false,
      "problemMatcher": [],
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      }
    },
    {
      "label": "Validate for Publish",
      "type": "shell",
      "command": "./scripts/validate-for-publish.sh",
      "group": "test",
      "isBackground": false,
      "problemMatcher": []
    },

    // === Platform Package Tasks ===
    {
      "label": "Build Platform Packages",
      "type": "shell",
      "command": "./scripts/build-platform-packages.sh",
      "group": "build",
      "isBackground": false,
      "problemMatcher": [],
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      }
    },
    {
      "label": "Test Platform Loading",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd node-wrapper && node -e \"try { const mod = require('./dist/index.js'); console.log('‚úÖ Platform loading successful'); console.log('Available functions:', Object.keys(mod)); console.log('Testing getPageCount:', typeof mod.getPageCount === 'function' ? '‚úÖ Available' : '‚ùå Missing'); } catch(e) { console.error('‚ùå Platform loading failed:', e.message); process.exit(1); }\""
      ],
      "group": "test",
      "isBackground": false,
      "dependsOn": ["Build All"],
      "problemMatcher": []
    },
    {
      "label": "Test All Platform Packages",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "echo 'üß™ Testing platform packages...' && for platform in linux-x64-gnu win32-x64-msvc darwin-x64 darwin-arm64; do echo \"Testing solopdf-cli-$platform...\"; if [ -f \"platform-packages/solopdf-cli-$platform/index.node\" ]; then size=$(stat -c%s \"platform-packages/solopdf-cli-$platform/index.node\" 2>/dev/null || stat -f%z \"platform-packages/solopdf-cli-$platform/index.node\" 2>/dev/null || echo '0'); if [ \"$size\" -gt 1000000 ]; then echo \"‚úÖ $platform: $(echo \"scale=1; $size/1024/1024\" | bc 2>/dev/null || awk \"BEGIN{printf \\\"%.1f\\\", $size/1024/1024}\")MB\"; else echo \"‚ö†Ô∏è  $platform: ${size}B (placeholder)\"; fi; else echo \"‚ùå $platform: missing\"; fi; done"
      ],
      "group": "test", 
      "isBackground": false,
      "dependsOn": ["Build Platform Packages"],
      "problemMatcher": []
    },
    {
      "label": "Test CLI Cross-Platform",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd node-wrapper && echo 'üß™ Testing CLI with current platform binary...' && node dist/cli.js --version && echo '‚úÖ CLI working on current platform' && echo 'Platform info:' && node -e 'console.log(`Platform: ${process.platform}-${process.arch}`); console.log(`Node.js: ${process.version}`);'"
      ],
      "group": "test",
      "isBackground": false,
      "dependsOn": ["Build All"],
      "problemMatcher": []
    },
    {
      "label": "Validate Platform Packages",
      "type": "shell", 
      "command": "bash",
      "args": [
        "-c",
        "echo 'üì¶ Validating platform packages...' && for platform in linux-x64-gnu win32-x64-msvc darwin-x64 darwin-arm64; do echo \"Validating solopdf-cli-$platform...\"; package_dir=\"platform-packages/solopdf-cli-$platform\"; if [ -f \"$package_dir/package.json\" ] && [ -f \"$package_dir/index.node\" ]; then echo \"‚úÖ Structure OK\"; node -e \"const pkg = require('./$package_dir/package.json'); console.log('  Name:', pkg.name); console.log('  Version:', pkg.version); console.log('  CPU:', pkg.cpu); console.log('  OS:', pkg.os);\"; else echo \"‚ùå Missing files\"; fi; echo ''; done"
      ],
      "group": "test",
      "isBackground": false, 
      "dependsOn": ["Build Platform Packages"],
      "problemMatcher": []
    },

    // === Development Tasks ===
    {
      "label": "Watch Rust Build",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && cargo watch -x 'build'"
      ],
      "group": "build",
      "isBackground": true,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Watch Rust Test",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && cargo watch -x 'test'"
      ],
      "group": "test",
      "isBackground": true,
      "problemMatcher": ["$rustc"]
    },

    // === Utility Tasks ===
    {
      "label": "Setup Test Environment",
      "type": "shell",
      "command": "node scripts/setup-execution-env.mjs",
      "group": "build",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Generate Test PDFs",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && source ~/.cargo/env 2>/dev/null || true && mkdir -p ../executed/generated-pdfs && cargo run --bin generate_test_pdfs -- ../executed/generated-pdfs"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": ["$rustc"]
    },
    {
      "label": "Clean All",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "cd rust-core && cargo clean && rm -rf node_modules target && cd ../node-wrapper && rm -rf node_modules dist coverage && pnpm install"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": []
    },

    // === Publishing Tasks ===
    {
      "label": "Publish to NPM",
      "type": "shell",
      "command": "./scripts/publish.sh",
      "group": "build",
      "isBackground": false,
      "problemMatcher": []
    },
    {
      "label": "Dry Run Publish",
      "type": "shell",
      "command": "cd node-wrapper && pnpm publish --dry-run",
      "group": "test",
      "isBackground": false,
      "dependsOn": ["Build All"],
      "problemMatcher": []
    },

    // === Complete Workflow Tasks ===
    {
      "label": "Full CI Pipeline",
      "dependsOrder": "sequence",
      "dependsOn": [
        "Format Check Rust",
        "Lint Rust",
        "Test Rust Core",
        "Build Rust Core",
        "Lint Node",
        "Test Node All",
        "Build Node Wrapper",
        "Test Platform Loading"
      ],
      "group": "test",
      "isBackground": false
    },
    {
      "label": "Full Platform Pipeline",
      "dependsOrder": "sequence", 
      "dependsOn": [
        "Full CI Pipeline",
        "Build Platform Packages",
        "Test All Platform Packages",
        "Validate Platform Packages",
        "Test CLI Cross-Platform"
      ],
      "group": "test",
      "isBackground": false,
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      }
    },
    {
      "label": "Pre-Publish Check",
      "dependsOrder": "sequence",
      "dependsOn": [
        "Full Platform Pipeline",
        "Validate for Publish",
        "Dry Run Publish"
      ],
      "group": "test",
      "isBackground": false
    },
    {
      "label": "Publish Platform Packages",
      "type": "shell",
      "command": "bash",
      "args": [
        "-c",
        "if [ -z \"$NPM_TOKEN\" ]; then echo '‚ùå NPM_TOKEN not set. Please set it first: export NPM_TOKEN=your_token'; exit 1; fi; ./scripts/build-platform-packages.sh --publish"
      ],
      "group": "build",
      "isBackground": false,
      "problemMatcher": []
    }
  ]
}
